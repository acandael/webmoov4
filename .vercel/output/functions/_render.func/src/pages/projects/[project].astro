---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Heading from "../../components/ui/Heading.astro";
import ProjectResults from "../../components/ProjectResults.astro";
import ProjectInfo from "../../components/ProjectInfo.astro";
import { Image } from "astro:assets";
import { projectImages, type ProjectId } from "../../lib/projectImages";
import StructuredData from "../../components/StructuredData.astro";

// In SSR, we need to fetch the project in the component script
const { project: projectSlug } = Astro.params;
let project: CollectionEntry<"projects"> | undefined;
let projectTestimonials: CollectionEntry<"testimonials">[] = [];

try {
	const projects = await getCollection("projects");
	project = projects.find((p) => p.slug === projectSlug);

	if (project) {
		// Only fetch testimonials if we found the project
		const allTestimonials = await getCollection("testimonials");
		projectTestimonials = allTestimonials.filter(
			(testimonial) => testimonial.data.project === project?.slug,
		);
	}
} catch (error) {
	console.error("Error fetching project:", error);
}

// Get project images from registry
const projectImage = project ? projectImages[project.slug as ProjectId] : undefined;

console.log("Current URL slug:", projectSlug);
console.log("Project found:", !!project);
if (project) {
	console.log("Project details:", {
		slug: project.slug,
		title: project.data.title,
		type: project.data.type,
	});
}

// Create Review schema if testimonials exist
const reviewSchemas = project && projectTestimonials.length > 0 ? projectTestimonials.map((testimonial) => ({
	"@context": "https://schema.org",
	"@type": "Review",
	itemReviewed: {
		"@type": "WebSite",
		name: project.data.title,
		url: project.data.website,
	},
	author: {
		"@type": "Person",
		name: testimonial.data.name,
	},
	reviewBody: testimonial.data.text,
	reviewRating: {
		"@type": "Rating",
		ratingValue: "5",
		bestRating: "5",
	},
})) : [];
---

<Layout
	title={`${project?.data.title} | Webmoov Project`}
	description={project?.data.subtitle}
	image={projectImage?.hero}
>
	{reviewSchemas.map((schema) => (
		<StructuredData schema={schema} />
	))}

	{
		project && projectImage ? (
			<>
				<section class="section">
					<div class="container">
						<Heading>
							<h1 class="section-title">Project: {project.data.title}</h1>
							<p class="subtitle">{project.data.subtitle}</p>
						</Heading>

						<div class="hero-image">
							<Image
								src={projectImage.hero}
								alt={project.data.title}
								width={1200}
								height={800}
								class="hero-image"
							/>
						</div>
					</div>
				</section>

				<ProjectInfo project={project} />
				<section class="section gallery-section">
					<div class="container">
						<div class="project-gallery">
							{projectImage.gallery.map((image, index) => (
								<div class="gallery-item">
									<Image
										src={image}
										alt={`${project.data.title} gallery image ${index + 1}`}
										width={800}
										height={600}
										class="gallery-image"
									/>
								</div>
							))}
						</div>
					</div>
				</section>
				<ProjectResults project={project} />
				{projectTestimonials.length > 0 && (
					<section class="section testimonial-section background-broken-white">
						<div class="container">
							{projectTestimonials.map((testimonial) => (
								<article class="testimonial">
									<blockquote class="testimonial-text">"{testimonial.data.text}"</blockquote>
									<div class="testimonial-author">
										<Image
											src={projectImages[project.slug as ProjectId].hero}
											alt={`${testimonial.data.name} avatar`}
											width={64}
											height={64}
											class="author-image"
										/>
										<div class="author-info">
											<h3>{testimonial.data.name}</h3>
											<p>{testimonial.data.role}</p>
										</div>
									</div>
								</article>
							))}
						</div>
					</section>
				)}
			</>
		) : (
			<section class="section">
				<div class="container">
					<Heading>
						<h1 class="section-title">Project niet gevonden</h1>
						<p class="subtitle">
							Het project dat u zoekt bestaat niet of is niet meer beschikbaar.
						</p>
					</Heading>
				</div>
			</section>
		)
	}
</Layout>

<style>
	.container {
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}

	.project-header {
		max-width: 70ch;
		margin-inline: auto;
	}

	/* .hero-image {
		@media (width > 760px) {
			margin-inline: calc(var(--container-padding) * -1);
		}
	} */

	.hero-image img {
		width: 100%;
		height: auto;
		object-fit: cover;
	}

	.gallery-section {
		background-color: var(--background-main);
	}

	.project-gallery {
		column-count: 3;
		column-gap: 1.5rem;
	}

	.gallery-item {
		break-inside: avoid;
		margin-bottom: 1.5rem;
		border-radius: var(--border-radius);
		overflow: hidden;
		position: relative;
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		background: #fff;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
	}

	.gallery-item::after {
		content: '';
		position: absolute;
		inset: 0;
		background: linear-gradient(
			to bottom,
			rgba(0, 0, 0, 0) 0%,
			rgba(0, 0, 0, 0.3) 100%
		);
		opacity: 0;
		transition: opacity 0.3s ease;
		pointer-events: none;
	}

	.gallery-item:hover {
		transform: translateY(-8px) scale(1.02);
		box-shadow: 0 12px 28px rgba(0, 0, 0, 0.15);
		z-index: 10;
	}

	.gallery-item:hover::after {
		opacity: 1;
	}

	.gallery-item img {
		width: 100%;
		height: auto;
		display: block;
		transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
	}

	.gallery-item:hover img {
		transform: scale(1.08);
	}

	/* Tablet */
	@media (max-width: 1024px) {
		.project-gallery {
			column-count: 2;
			column-gap: 1.25rem;
		}

		.gallery-item {
			margin-bottom: 1.25rem;
		}
	}

	/* Mobile */
	@media (max-width: 640px) {
		.project-gallery {
			column-count: 1;
			column-gap: 0;
		}

		.gallery-item {
			margin-bottom: 1rem;
		}

		.gallery-item:hover {
			transform: translateY(-4px) scale(1.01);
		}
	}

	@media (max-width: 760px) {
		.project-results {
			padding: 2rem;
		}

		.results-grid {
			gap: 2rem;
		}
	}

	.testimonial-section {
		margin-block-start: 0;
		padding-block-start: 0;
	}

	.testimonial {
		max-width: 800px;
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 2rem;
		text-align: center;
		margin-inline: auto;
	}

	.testimonial-text {
		font-size: var(--font-size-xl);
		line-height: 1.5;
		color: var(--text-body);
		max-width: 65ch;
		margin: 0;
	}

	.testimonial-author {
		display: flex;
		align-items: center;
		gap: 1rem;
	}

	.testimonial-author img {
		width: 4rem;
		height: 4rem;
		border-radius: 50%;
		object-fit: cover;
	}

	.author-info {
		text-align: left;

		h3 {
			font-family: var(--ff-accent);
			font-size: var(--font-size-regular);
			font-weight: 600;
			color: var(--text-heading);
			margin-bottom: 0.25rem;
		}

		p {
			font-size: var(--font-size-sm);
			color: var(--text-body);
		}
	}

	@media (max-width: 768px) {
		.testimonial-section {
			padding-block-end: 7.5rem;
		}

		.testimonial-text {
			font-size: var(--font-size-lg);
			padding-inline: 1rem;
		}
	}
</style>
